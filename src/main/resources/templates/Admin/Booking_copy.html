<!DOCTYPE html>
<html>

<head>
	<title>Hoteru Managerment</title>

	<meta name="viewport"
		content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="icon" type="image/png" th:href="@{/img/location.png}" />

	<!-- Import lib -->
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css">
	<link rel="stylesheet" type="text/css" th:href="@{/Admin/fontawesome-free/css/all.min.css}">
	<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
	<!-- End import lib -->
	<link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@300&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css" type="text/css">
	<script src="https://cdn.webix.com/edge/webix.js" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" th:href="@{/Admin/style.css}">
</head>

<body class="overlay-scrollbar" onload="createnoti()">
	<!-- navbar -->
	<div class="navbar">
		<!-- nav left -->
		<ul class="navbar-nav">
			<li class="nav-item">
				<a class="nav-link">
					<i class="fas fa-bars" onclick="collapseSidebar()"></i>
				</a>
			</li>
			<li class="nav-item">
				<img th:src="@{/img/logo-black.png}" alt="Hoteru logo" class="logo logo-light">
				<img th:src="@{/img/logo.png}" alt="Hoteru logo" class="logo logo-dark">
			</li>
		</ul>
		<!-- end nav left -->
		<!-- form -->

		<!-- end form -->
		<!-- nav right -->
		<ul class="navbar-nav nav-right">
			<li class="nav-item mode">
				<a class="nav-link" href="#" onclick="switchTheme()">
					<i class="fas fa-moon dark-icon"></i>
					<i class="fas fa-sun light-icon"></i>
				</a>
			</li>
			<li class="nav-item dropdown">
				<a class="nav-link">
					<i class="fas fa-bell dropdown-toggle" data-toggle="notification-menu"></i>
					<span id="numberNoti" class="navbar-badge">0</span>
				</a>
				<ul id="notification-menu" class="dropdown-menu notification-menu">
					<div class="dropdown-menu-header">
						<span>
							Notifications
						</span>
					</div>
					<div id="notification" class="dropdown-menu-content overlay-scrollbar scrollbar-hover">

					</div>
				</ul>
			</li>
			<li class="nav-item avt-wrapper">
				<div class="avt dropdown">
					<img src="https://us.123rf.com/450wm/donets/donets1508/donets150800333/43440158-vector-user-icon-of-man-in-business-suit.jpg?ver=6"
						alt="User image" class="dropdown-toggle" data-toggle="user-menu">
					<ul id="user-menu" class="dropdown-menu">
						<li class="dropdown-menu-item">
							<a href="/logout" class="dropdown-menu-link">
								<div>
									<i class="fas fa-sign-out-alt"></i>
								</div>
								<span>Logout</span>
							</a>
						</li>
					</ul>
				</div>
			</li>
		</ul>
		<!-- end nav right -->
	</div>
	<!-- end navbar -->
	<!-- sidebar -->
	<div class="sidebar">
		<ul class="sidebar-nav">
			<li class="sidebar-nav-item">
				<a th:href="@{/admin/index}" class="sidebar-nav-link">
					<div>
						<i class="fas fa-tachometer-alt"></i>
					</div>
					<span>
						Dashboard
					</span>
				</a>
			</li>
			<li class="sidebar-nav-item">
				<a th:href="@{/admin/customermgmt}" class="sidebar-nav-link ">
					<div>
						<i class="fas fa-users"></i>
					</div>
					<span>Customer Mgmt</span>
				</a>
			</li>
			<li class="sidebar-nav-item">
				<a th:href="@{/admin/roommgmt}" class="sidebar-nav-link">
					<div>
						<i class="fas fa-bed"></i>
					</div>
					<span>Rooms Mgmt</span>
				</a>
			</li>
			<li class="sidebar-nav-item">
				<a th:href="@{/admin/servicemgmt}" class="sidebar-nav-link">
					<div>
						<i class="fas fa-concierge-bell"></i>
					</div>
					<span>Services Mgmt</span>
				</a>
			</li>
			<li class="sidebar-nav-item">
				<a th:href="@{/admin/foodmgmt}" class="sidebar-nav-link">
					<div>
						<i class="fas fa-utensils"></i>
					</div>
					<span>Foods Mgmt</span>
				</a>
			</li>
			<li class="sidebar-nav-item">
				<a th:href="@{/admin/bookingmgmt}" class="sidebar-nav-link active">
					<div>
						<i class="fas fa-chart-line"></i>
					</div>
					<span>Booking Mgmt</span>
				</a>
			</li>
		</ul>
	</div>
	<!-- end sidebar -->
	<!-- main content -->
	<div class="wrapper">
		<div class="row">
			<div class="col-12 col-m-12 col-sm-12">
				<div class="card">
					<div class="card-header">
						<h3>
							Booking Management
						</h3>
					</div>
					<div class="card-content">
						<div id="mgmtBody"></div>
					</div>
				</div>
				<div class="card-content col-12">
					<div class="col6"><center><img src="/img/FPT_Polytechnic.png" width="10%" height="10%"></center></div>
					<div class="col6" style="padding-top: 5px"><center>Copyright 2021 by FPT_Polytechnic. All Rights Reserved.</center></div>
				</div>
			</div>
		</div>
	</div>
	<!-- end main content -->
	<!-- import script -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
	<script th:src="@{/Admin/index.js}"></script>
	<!-- end import script -->
</body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
	webix.ready(async function () {
		await searchService();
		await webix.ui({
			"container": "mgmtBody",
			css: "container",
			autoheight: true,
			autowidth: true,
			"cols": [
				{
					rows: [
						{
							columns: [
								{ id: "id", "header": "ID BOOKING", "sort": "int", fillspace: 2 },
								{ id: "fullname", header: ["CUSTOMER NAME", { content: "textFilter" }], "sort": "string", fillspace: 5 },
								{ id: "total", "header": "TOTAL", "sort": "int", fillspace: 2, },

							],
							"view": "datatable",
							id: "tableBooking",
							select: true,
							scroll: "y",
							data: ListBooking,
							width: 800,
							height: 550
						},
						{
							rows: [
								{
									"view": "button", id: "btnExport", "css": "webix_primary", "label": "Export Data",
									"borderless": 1, width: 100, click: function () {
										var key = $$("tableBooking").getFilter("fullname").value;
										location.href = '/excel/booking?key=' + key;
									}
								},
							]
						},

					]
				},

				{

					"view": "form",
					id: "formBooking",
					// "borderless": 1,
					disabled: true,
					autoheight: true,
					autowidth: true,
					"rows": [
						{ "view": "text", id: "txtID", "label": "ID", "name": "id", readonly: true },
						{ "view": "text", id: "txtCustomer", "label": "Customer", "name": "fullname", readonly: true },
						{ "view": "text", id: "txtRoom", "label": "Room", readonly: true },
						{ "view": "text", id: "txtCreate", "label": "Cre. Date", readonly: true },
						{ "view": "text", id: "txtstartdate", "label": "Start Date", readonly: true },
						{ "view": "text", id: "txtenddate", "label": "End Date", readonly: true },
						{ "view": "text", id: "txtPhone", "label": "Phone No.", "name": "phone", readonly: true },
						{
							view: "template",
							borderless: 1,
							template: "<center><h3>Detail Receipt</h3></center>"
						},
						{
							"cols": [
								{ "view": "text", id: "txtRoomPrice", "label": "Room", format: "1,111", labelAlign: "center", readonly: true },
								{ "view": "text", id: "txtS&FPrice", "label": "Services", format: "1,111", labelAlign: "center", readonly: true }
							]
						},
						{ "view": "text", id: "txtTotal", "label": "Total", "name": "total", format: "1,111", labelAlign: "center", readonly: true },



						{
							"cols": [
								{
									"view": "button", "css": "webix_primary", "label": "Service Selection",
									"borderless,": 1, click: function () {

										webix.ui(popupService).show();
										$$('girdService').parse(selectionSerivce)
									}
								},
								{
									"view": "button", "css": "webix_primary", "label": "Food Selection",
									"borderless": 1, click: function () {

										webix.ui(popupFood).show();
										$$('girdFood').parse(selectionFood)

									}
								}
							]
						},

						{
							"view": "radio", id: "rdoStatus", "label": "Status", labelAlign: "center",
							options: [
								{ value: "PENDING", id: "PENDING" },
								{ value: "COMPLETED", id: "COMPLETED" },
								{ value: "CANCEL", id: "CANCEL" }
							],
						},
					],


					
				}
			]
		}
		);

		$$("formBooking").bind("tableBooking");
		$$("tableBooking").attachEvent("onSelectChange", function () {

			$$("formBooking").enable();
			var id = $$("txtID").getValue();

			axios.get("/getOne/" + id).then(function (response) {
				let BookingDetails = response.data;
				console.log(BookingDetails)
				$$("txtRoom").setValue(BookingDetails.roomb.name);
				$$("rdoStatus").setValue(BookingDetails.status);
				$$("txtstartdate").setValue((BookingDetails.inDate).slice(0, 10));
				$$("txtenddate").setValue((BookingDetails.outDate).slice(0, 10));
				$$("txtCreate").setValue((BookingDetails.bookDate).slice(0, 10));
				$$("txtRoomPrice").setValue((BookingDetails.roomb.roomType.price));
				$$("txtS&FPrice").setValue((BookingDetails.total) - (BookingDetails.roomb.roomType.price));

			});

			axios.get("/report/service-food/book?id=" + id).then(function (response) {
				let Selections = response.data;
				selectionFood = Selections.listFoods;
				selectionSerivce = Selections.listServices;
			});

		});

		$$("rdoStatus").attachEvent("onItemClick", function () {
			webix.confirm({
				title: "Title",
				ok: "Yes", cancel: "No",
				text: "Are you sure to change this status?"
			})
				.then(function () {
					let detail = {
						id: $$("txtID").getValue(),
						status: $$("rdoStatus").getValue()
					}
					axios.post('/updateBooking', detail)
						.then(function (response) {
							if (response.data == true) {
								createnoti();
								webix.alert({
									title: "Successfully!",
								})
							}
						})
						.catch(function (error) {
							webix.alert({
								type: "alert-error",
								title: "An Error Occurred",
							});
						});
				})
				.fail(function () {
					var OldId = $$("txtID").getValue();
					axios.get("/getOne/" + OldId).then(function (response) {
						let OldBookingDetails = response.data;
						$$("rdoStatus").setValue(OldBookingDetails.status);

					});
				});
		});
	});

	const popupService = {
		view: "window",
		id: "winService",
		// height: 450,
		autoheight: true,
		position: "center",
		move: true,
		width: 800,
		left: 450, top: 50,
		head: {
			view: "toolbar", cols: [
				{ width: 4 },
				{ view: "label", label: "Selection Service" },
				{ view: "button", label: 'Close', width: 100, align: 'right', click: function () { $$('winService').close(); } }
			]
		},
		body: {
			view: "datatable",
			id: "girdService",
			columns: [
				{ id: "id", header: "Id", width: 50 },
				{ id: "name", header: "Service Name", width: 200 },
				{ id: "price", header: "Price", width: 100 }
			],
			select: "row",
			autoheight: true,
			autowidth: true,
			//data:selectionSerivce
		}
	}

	const popupFood = {
		view: "window",
		id: "winFood",
		autoheight: true,
		position: "center",
		move: true,
		width: 800,
		left: 450, top: 50,
		head: {
			view: "toolbar", cols: [
				{ width: 4 },
				{ view: "label", label: "Selection Food" },
				{ view: "button", label: 'Close', width: 100, align: 'right', click: function () { $$('winFood').close(); } }
			]
		},
		body: {
			view: "datatable",
			id: "girdFood",
			columns: [
				{ id: "id", header: "ID", width: 50 },
				{ id: "name", header: "Food Name", width: 200 },
				{ id: "price", header: "Price", width: 100 }
			],
			select: "row",
			autoheight: true,
			autowidth: true,
			//data: selectionFood
		}
	}
</script>


<!-- function -->
<script>
	let ListBooking = [];
	let selectionFood = [];
	let selectionSerivce = [];
	function searchService() {
		axios.get('/getAllBooking')
			.then(function (response) {
				ListBooking = response.data;
				$$("tableBooking").parse(ListBooking, "json");
				//console.log(ListBooking);
			})
			.catch(function (error) {
				console.error(error)
			});
	}

	// function save() {
	// 	const obj = {
	// 		id: $$("txtID").getValue(),
	// 		name: $$("txtName").getValue(),
	// 		price: $$("txtPrice").getValue(),
	// 		description: $$("txtDesc").getValue(),
	// 	}

	// 	axios.post('/api/insertService', obj).then(function (response) {
	// 		webix.alert({
	// 			title: "Successfully!",
	// 		}).then(function () {
	// 			location.reload();
	// 		});

	// 	})
	// 		.catch(function (error) {
	// 			webix.alert({
	// 				type: "alert-error",
	// 				title: "An Error Occurred",
	// 			});
	// 		});

	// }

</script>
<script th:src="@{/Admin/notifacation.js}"></script>
</html>